<!DOCTYPE html>
<html>
<head>
    <title>Conveyor IoT Dashboard - Realtime & History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; }
        .data-box, .control-panel { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .realtime span { font-weight: bold; color: #007bff; margin-left: 10px; font-size: 1.2em; }
        
        .control-panel { text-align: center; }
        button { padding: 12px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: opacity 0.3s; }
        .btn-run { background-color: #28a745; }
        .btn-stop { background-color: #ffc107; color: black; }
        .btn-emergency { background-color: #dc3545; }
        .btn-reset { background-color: #17a2b8; }
        button:hover { opacity: 0.8; transform: scale(1.05); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéõÔ∏è Conveyor Belt IoT Dashboard</h1>

        <div class="data-box realtime">
            <h2>D·ªØ li·ªáu Th·ªùi gian th·ª±c</h2>
            <p>üì¶ S·ªë L∆∞·ª£ng: <span id="so_luong">--</span></p>
            <p>üé® M√†u S·∫Øc: <span id="mau">--</span></p>
            <p>‚öôÔ∏è Tr·∫°ng Th√°i: <span id="trang_thai">--</span></p>
            <p>üì° MQTT Status: <span id="mqtt-status" style="color:red; font-size:14px;">Disconnected</span></p>
        </div>

       <div class="data-box control-panel">
            <h2>B·∫£ng ƒêi·ªÅu khi·ªÉn</h2>
            
            <button class="btn-run" onclick="publishCommand('MOTOR_RUN')">‚ñ∂ CH·∫†Y</button>
            <button class="btn-stop" onclick="publishCommand('MOTOR_STOP')">‚è∏ D·ª™NG</button>
            <button class="btn-reset" onclick="publishCommand('RESET_COUNT')">üîÑ RESET ƒê·∫æM</button>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

           <div style="margin-top: 15px;">
                <p style="font-weight: bold; font-size: 18px;">
                    ‚ö° Ch·∫ø ƒë·ªô: <span id="hien_thi_che_do" style="color: #dc3545;">M·∫†NH NH·∫§T (255)</span>
                </p>
                
                <button class="btn-speed" onclick="publishCommand('CHANGE_SPEED_LEVEL')" 
                        style="background-color: #6f42c1; width: 100%; padding: 15px; font-size: 16px;">
                    üéö ƒê·ªîI T·ªêC ƒê·ªò (M·∫°nh -> V·ª´a -> Ch·∫≠m)
                </button>
            </div>
        </div>

        <div class="data-box history">
            <h2>üìú L·ªãch s·ª≠ Ho·∫°t ƒë·ªông (Database)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>M√†u s·∫Øc</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // ================= C·∫§U H√åNH MQTT (Websocket Secure) =================
        // L∆∞u √Ω: Port cho Web ph·∫£i l√† WSS (th∆∞·ªùng l√† 8884 tr√™n HiveMQ), KH√îNG PH·∫¢I 8883
        const MQTT_SERVER = "22d9a4bac641496a885db88574135654.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884; 
        const MQTT_USER = "tlong";      // Nh·∫≠p ƒë√∫ng user HiveMQ c·ªßa b·∫°n
        const MQTT_PASS = "Tlong1234";  // Nh·∫≠p ƒë√∫ng pass HiveMQ c·ªßa b·∫°n
        
        const MQTT_TOPIC_DATA = "tlong/bangchuyen/data";
        const MQTT_TOPIC_COMMAND = "tlong/bangchuyen/command";
        // ====================================================================

        let mqttClient;
        let isConnected = false; // Bi·∫øn c·ªù t·ª± qu·∫£n l√Ω tr·∫°ng th√°i k·∫øt n·ªëi

        // 1. K·∫æT N·ªêI MQTT
        function connectMQTT() {
            const clientId = "web-" + parseInt(Math.random() * 100000);
            mqttClient = new Paho.MQTT.Client(MQTT_SERVER, Number(MQTT_PORT), "/mqtt", clientId);

            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true, // HiveMQ Cloud b·∫Øt bu·ªôc SSL
                userName: MQTT_USER,
                password: MQTT_PASS,
                onSuccess: onConnect,
                onFailure: onFailure,
                timeout: 5
            };

            console.log("Connecting to MQTT...");
            document.getElementById("mqtt-status").innerText = "Connecting...";
            mqttClient.connect(options);
        }

        function onConnect() {
            console.log("MQTT Connected!");
            isConnected = true;
            document.getElementById("mqtt-status").innerText = "Connected ‚úÖ";
            document.getElementById("mqtt-status").style.color = "green";
            
            // ƒêƒÉng k√Ω nh·∫≠n d·ªØ li·ªáu
            mqttClient.subscribe(MQTT_TOPIC_DATA);
            
            // T·∫£i l·ªãch s·ª≠ l·∫ßn ƒë·∫ßu
            loadHistoryData();
        }

        function onFailure(message) {
            console.log("Connection Failed: " + message.errorMessage);
            document.getElementById("mqtt-status").innerText = "Failed ‚ùå (Retrying...)";
            setTimeout(connectMQTT, 5000); // Th·ª≠ l·∫°i sau 5s
        }

        function onConnectionLost(responseObject) {
            isConnected = false;
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                document.getElementById("mqtt-status").innerText = "Lost connection ‚ö†Ô∏è";
                document.getElementById("mqtt-status").style.color = "red";
                setTimeout(connectMQTT, 5000); // Th·ª≠ l·∫°i
            }
        }

        // 2. NH·∫¨N D·ªÆ LI·ªÜU T·ª™ ESP8266 (REAL-TIME)
       function onMessageArrived(message) {
            if (message.destinationName === MQTT_TOPIC_DATA) {
                try {
                    const payload = message.payloadString.trim();
                    const data = JSON.parse(payload);

                    document.getElementById('so_luong').innerText = data.soluong;
                    document.getElementById('mau').innerText = data.mau;
                    document.getElementById('trang_thai').innerText = data.trangthai;
                    
                    // --- C·∫¨P NH·∫¨T HI·ªÇN TH·ªä CH·∫æ ƒê·ªò T·ªêC ƒê·ªò ---
                    if(data.tocdo) {
                         let textStatus = "";
                         let color = "";
                         
                         // D·ª±a v√†o gi√° tr·ªã PWM ƒë·ªÉ ƒëo√°n t√™n ch·∫ø ƒë·ªô
                         if (data.tocdo >= 250) {
                             textStatus = "M·∫†NH NH·∫§T (255)"; color = "#dc3545"; // ƒê·ªè
                         } else if (data.tocdo >= 150) {
                             textStatus = "TRUNG B√åNH (160)"; color = "#28a745"; // Xanh l√°
                         } else {
                             textStatus = "CH·∫¨M (100)"; color = "#ffc107"; // V√†ng
                         }
                         
                         const label = document.getElementById('hien_thi_che_do');
                         label.innerText = textStatus;
                         label.style.color = color;
                    }

                    addRecordToHistory(data, true);
                } catch (e) { console.error("JSON Error:", e); }
            }
        }

        // 3. G·ª¨I L·ªÜNH ƒêI·ªÄU KHI·ªÇN (Run/Stop)
        function publishCommand(cmd) {
            if (!isConnected) {
                alert("M·∫•t k·∫øt n·ªëi MQTT! ƒêang k·∫øt n·ªëi l·∫°i...");
                return;
            }
            try {
                const message = new Paho.MQTT.Message(cmd);
                message.destinationName = MQTT_TOPIC_COMMAND;
                mqttClient.send(message);
                console.log("Sent command:", cmd);
            } catch (e) {
                console.error("Send Error:", e);
            }
        }

        // H√†m g·ª≠i l·ªánh ch·ªânh t·ªëc ƒë·ªô
        function updateSpeed(val) {
            // G·ª≠i l·ªánh d·∫°ng: "SPEED:200"
            publishCommand("SPEED:" + val);
        }

        // S·ª≠a l·∫°i h√†m nh·∫≠n d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t thanh tr∆∞·ª£t n·∫øu Arduino g·ª≠i v·ªÅ
        function onMessageArrived(message) {
            if (message.destinationName === MQTT_TOPIC_DATA) {
                try {
                    const payload = message.payloadString.trim();
                    const data = JSON.parse(payload);

                    document.getElementById('so_luong').innerText = data.soluong;
                    document.getElementById('mau').innerText = data.mau;
                    document.getElementById('trang_thai').innerText = data.trangthai;
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªëc ƒë·ªô hi·ªán t·∫°i t·ª´ ph·∫ßn c·ª©ng g·ª≠i l√™n
                    if(data.tocdo) {
                         document.getElementById('hien_thi_toc_do').innerText = data.tocdo;
                         document.getElementById('speedRange').value = data.tocdo;
                    }

                    addRecordToHistory(data, true);
                } catch (e) { console.error("JSON Error:", e); }
            }
        }

        // 4. L·∫§Y L·ªäCH S·ª¨ T·ª™ API (Server Render)
        async function loadHistoryData() {
            try {
                // S·ª¨A: D√πng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi, t·ª± ƒë·ªông nh·∫≠n di·ªán domain c·ªßa Render
                const response = await fetch('/api/history'); 
                const historyData = await response.json();

                const tableBody = document.getElementById('history-table-body');
                tableBody.innerHTML = ''; // X√≥a c≈©

                historyData.forEach(data => addRecordToHistory(data));

            } catch (error) {
                console.error("API Error:", error);
            }
        }

        function addRecordToHistory(data, isNew = false) {
            const tableBody = document.getElementById('history-table-body');
            const row = tableBody.insertRow(0); // Ch√®n l√™n ƒë·∫ßu

            // X·ª≠ l√Ω th·ªùi gian
            const timeStr = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('vi-VN') : new Date().toLocaleTimeString('vi-VN');

            row.innerHTML = `
                <td>${timeStr}</td>
                <td>${data.mau}</td>
                <td>${data.soluong}</td>
                <td>${data.trangthai}</td>
            `;

            if (isNew) {
                row.style.backgroundColor = "#e8f5e9"; // M√†u xanh nh·∫°t cho d√≤ng m·ªõi
                setTimeout(() => row.style.backgroundColor = "white", 2000);
            }
        }

        // Kh·ªüi ch·∫°y
        connectMQTT();
    </script>
</body>

</html>

