<!DOCTYPE html>
<html>
<head>
    <title>Conveyor IoT Dashboard - Advanced</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; margin-bottom: 20px; }
        
        .data-box { margin-bottom: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; }
        
        /* REALTIME SECTION */
        .realtime p { font-size: 16px; margin: 10px 0; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .realtime span { font-weight: bold; color: #007bff; float: right; font-size: 1.2em; }
        
        /* CONTROL PANEL */
        .control-panel { text-align: center; background-color: #f9f9f9; }
        button { padding: 12px 25px; margin: 8px; cursor: pointer; border: none; border-radius: 50px; color: white; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-run { background-color: #28a745; }
        .btn-stop { background-color: #ffc107; color: #333; }
        .btn-speed { background-color: #6f42c1; } /* M√†u t√≠m cho n√∫t t·ªëc ƒë·ªô */
        .btn-reset { background-color: #17a2b8; }
        
        /* FILTER & SORT SECTION */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; justify-content: space-between; flex-wrap: wrap; }
        .filter-group { flex: 1; min-width: 200px; }
        select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
        label { font-weight: bold; font-size: 12px; color: #666; display: block; margin-bottom: 5px; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; }
        tr:hover { background-color: #f1f1f1; }
        
        /* Status Tags */
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: white; }
        .tag-red { background-color: #dc3545; }
        .tag-green { background-color: #28a745; }
        .tag-blue { background-color: #007bff; }
        .tag-other { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéõÔ∏è Conveyor Dashboard Pro</h1>

        <div class="data-box realtime">
            <h2>D·ªØ li·ªáu Th·ªùi gian th·ª±c</h2>
            <p>üì¶ S·ªë L∆∞·ª£ng: <span id="so_luong">--</span></p>
            <p>üé® M√†u S·∫Øc: <span id="mau">--</span></p>
            <p>‚öôÔ∏è Tr·∫°ng Th√°i: <span id="trang_thai">--</span></p>
            <p>‚ö° T·ªëc ƒë·ªô/Ch·∫ø ƒë·ªô: <span id="hien_thi_che_do" style="color:#6f42c1">--</span></p>
            <p style="border:none; font-size:12px; color:gray;">MQTT: <span id="mqtt-status" style="font-weight:normal; font-size:12px;">Connecting...</span></p>
        </div>

        <div class="data-box control-panel">
            <h2>ƒêi·ªÅu khi·ªÉn</h2>
            <button class="btn-run" onclick="publishCommand('MOTOR_RUN')">‚ñ∂ CH·∫†Y</button>
            <button class="btn-stop" onclick="publishCommand('MOTOR_STOP')">‚è∏ D·ª™NG</button>
            <button class="btn-speed" onclick="publishCommand('CHANGE_SPEED_LEVEL')">‚ö° ƒê·ªîI T·ªêC ƒê·ªò</button>
            <br>
            <button class="btn-reset" onclick="publishCommand('RESET_COUNT')" style="font-size: 12px; padding: 8px 15px; margin-top: 15px;">üîÑ Reset ƒê·∫øm</button>
        </div>

        <div class="data-box history">
            <h2>üìú L·ªãch s·ª≠ & B·ªô l·ªçc</h2>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label>üîç L·ªçc theo m√†u s·∫Øc:</label>
                    <select id="filterColor" onchange="applyFilterAndSort()">
                        <option value="ALL">T·∫•t c·∫£</option>
                        <option value="RED">ƒê·ªè (RED)</option>
                        <option value="GREEN">Xanh L√° (GREEN)</option>
                        <option value="BLUE">Xanh D∆∞∆°ng (BLUE)</option>
                        <option value="ERROR">L·ªói / Kh√°c</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üîÉ S·∫Øp x·∫øp theo:</label>
                    <select id="sortType" onchange="applyFilterAndSort()">
                        <option value="NEWEST">M·ªõi nh·∫•t tr∆∞·ªõc</option>
                        <option value="OLDEST">C≈© nh·∫•t tr∆∞·ªõc</option>
                        <option value="QTY_DESC">S·ªë l∆∞·ª£ng (Cao -> Th·∫•p)</option>
                    </select>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>M√†u s·∫Øc</th>
                        <th>SL</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH MQTT ===
        const MQTT_SERVER = "22d9a4bac641496a885db88574135654.s1.eu.hivemq.cloud";
        const MQTT_PORT = 8884; 
        const MQTT_USER = "tlong";      
        const MQTT_PASS = "Tlong1234";  
        const MQTT_TOPIC_DATA = "tlong/bangchuyen/data";
        const MQTT_TOPIC_COMMAND = "tlong/bangchuyen/command";

        let mqttClient;
        // BI·∫æN L∆ØU TR·ªÆ TO√ÄN B·ªò D·ªÆ LI·ªÜU ƒê·ªÇ L·ªåC
        let globalHistoryData = []; 

        // 1. K·∫æT N·ªêI MQTT
        function connectMQTT() {
            const clientId = "web-" + parseInt(Math.random() * 100000);
            mqttClient = new Paho.MQTT.Client(MQTT_SERVER, Number(MQTT_PORT), "/mqtt", clientId);
            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;
            mqttClient.connect({
                useSSL: true, userName: MQTT_USER, password: MQTT_PASS,
                onSuccess: onConnect, onFailure: onFailure
            });
        }
        function onConnect() {
            document.getElementById("mqtt-status").innerText = "Connected ‚úÖ";
            document.getElementById("mqtt-status").style.color = "green";
            mqttClient.subscribe(MQTT_TOPIC_DATA);
            loadHistoryData(); // T·∫£i l·ªãch s·ª≠ ban ƒë·∫ßu
        }
        function onFailure(e) { console.log(e); setTimeout(connectMQTT, 5000); }
        function onConnectionLost(e) { if(e.errorCode!==0) setTimeout(connectMQTT, 5000); }

        // 2. G·ª¨I L·ªÜNH
        function publishCommand(cmd) {
            try {
                const message = new Paho.MQTT.Message(cmd);
                message.destinationName = MQTT_TOPIC_COMMAND;
                mqttClient.send(message);
            } catch(e) { alert("Ch∆∞a k·∫øt n·ªëi MQTT!"); }
        }

        // 3. NH·∫¨N D·ªÆ LI·ªÜU (REALTIME)
        function onMessageArrived(message) {
            if (message.destinationName === MQTT_TOPIC_DATA) {
                try {
                    const data = JSON.parse(message.payloadString.trim());

                    // C·∫≠p nh·∫≠t s·ªë li·ªáu Realtime
                    document.getElementById('so_luong').innerText = data.soluong;
                    document.getElementById('mau').innerText = data.mau;
                    document.getElementById('trang_thai').innerText = data.trangthai;
                    
                    // C·∫≠p nh·∫≠t Text ch·∫ø ƒë·ªô
                    updateSpeedText(data.tocdo);

                    // TH√äM V√ÄO M·∫¢NG D·ªÆ LI·ªÜU CHUNG V√Ä V·∫º L·∫†I B·∫¢NG
                    // Th√™m th·ªùi gian hi·ªán t·∫°i n·∫øu thi·∫øu
                    if(!data.timestamp) data.timestamp = new Date().toISOString();
                    
                    globalHistoryData.unshift(data); // Th√™m v√†o ƒë·∫ßu m·∫£ng
                    
                    // N·∫øu m·∫£ng qu√° d√†i (>100), c·∫Øt b·ªõt ƒë·ªÉ nh·∫π tr√¨nh duy·ªát
                    if(globalHistoryData.length > 100) globalHistoryData.pop();

                    // G·ªçi h√†m l·ªçc ƒë·ªÉ v·∫Ω l·∫°i b·∫£ng ngay l·∫≠p t·ª©c
                    applyFilterAndSort();

                } catch (e) { console.error(e); }
            }
        }

        // H√†m c·∫≠p nh·∫≠t ch·ªØ hi·ªÉn th·ªã t·ªëc ƒë·ªô
        function updateSpeedText(val) {
            if(!val) return;
            const lbl = document.getElementById('hien_thi_che_do');
            if (val >= 250) { lbl.innerText = "M·∫†NH NH·∫§T (255)"; lbl.style.color = "#dc3545"; }
            else if (val >= 150) { lbl.innerText = "TRUNG B√åNH (160)"; lbl.style.color = "#28a745"; }
            else { lbl.innerText = "CH·∫¨M (100)"; lbl.style.color = "#ffc107"; }
        }

        // 4. L·∫§Y L·ªäCH S·ª¨ T·ª™ SERVER
        async function loadHistoryData() {
            try {
                const response = await fetch('/api/history'); 
                const data = await response.json();
                
                // L∆∞u v√†o bi·∫øn to√†n c·ª•c
                globalHistoryData = data;
                
                // V·∫Ω b·∫£ng
                applyFilterAndSort();
            } catch (error) { console.error("API Error:", error); }
        }

        // ============================================================
        // 5. LOGIC L·ªåC V√Ä S·∫ÆP X·∫æP (FILTER & SORT) - QUAN TR·ªåNG NH·∫§T
        // ============================================================
        function applyFilterAndSort() {
            // L·∫•y gi√° tr·ªã ƒëang ch·ªçn trong menu
            const filterValue = document.getElementById('filterColor').value;
            const sortType = document.getElementById('sortType').value;

            // A. COPY m·∫£ng g·ªëc ra ƒë·ªÉ x·ª≠ l√Ω (kh√¥ng l√†m h·ªèng d·ªØ li·ªáu g·ªëc)
            let processedData = [...globalHistoryData];

            // B. X·ª¨ L√ù L·ªåC (FILTER)
            if (filterValue !== 'ALL') {
                processedData = processedData.filter(item => {
                    // N·∫øu ch·ªçn ERROR, l·∫•y c·∫£ KHAC v√† ERROR
                    if(filterValue === 'ERROR') return item.mau === 'ERROR' || item.mau === 'KHAC' || item.mau === 'NONE';
                    // C√°c m√†u kh√°c th√¨ so s√°nh ch√≠nh x√°c
                    return item.mau === filterValue;
                });
            }

            // C. X·ª¨ L√ù S·∫ÆP X·∫æP (SORT)
            processedData.sort((a, b) => {
                const timeA = new Date(a.timestamp || 0).getTime();
                const timeB = new Date(b.timestamp || 0).getTime();

                if (sortType === 'NEWEST') return timeB - timeA; // M·ªõi nh·∫•t tr∆∞·ªõc
                if (sortType === 'OLDEST') return timeA - timeB; // C≈© nh·∫•t tr∆∞·ªõc
                if (sortType === 'QTY_DESC') return b.soluong - a.soluong; // S·ªë l∆∞·ª£ng gi·∫£m d·∫ßn
                return 0;
            });

            // D. V·∫º L·∫†I B·∫¢NG HTML
            renderTable(processedData);
        }

        function renderTable(dataArray) {
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = ''; // X√≥a b·∫£ng c≈©

            if(dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o!</td></tr>';
                return;
            }

            dataArray.forEach(data => {
                const row = tableBody.insertRow();
                
                // X·ª≠ l√Ω m√†u s·∫Øc hi·ªÉn th·ªã cho ƒë·∫πp
                let colorTag = `<span class="tag tag-other">${data.mau}</span>`;
                if(data.mau === 'RED') colorTag = `<span class="tag tag-red">RED</span>`;
                else if(data.mau === 'GREEN') colorTag = `<span class="tag tag-green">GREEN</span>`;
                else if(data.mau === 'BLUE') colorTag = `<span class="tag tag-blue">BLUE</span>`;

                const timeStr = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('vi-VN') : '--';

                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${colorTag}</td>
                    <td>${data.soluong}</td>
                    <td>${data.trangthai}</td>
                `;
            });
        }

        // Kh·ªüi ƒë·ªông
        connectMQTT();
    </script>
</body>
</html>
